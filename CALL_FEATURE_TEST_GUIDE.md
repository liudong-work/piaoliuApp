# 🎤 语音/视频通话功能测试指南

## 📋 功能概述

漂流瓶应用现在支持语音通话和视频通话功能！用户可以在聊天界面直接发起通话，与对方进行实时语音或视频交流。

## 🚀 快速开始

### 1. 启动服务
```bash
# 启动所有服务（API服务器 + 信令服务器）
./start-call-services.sh

# 停止所有服务
./stop-call-services.sh
```

### 2. 构建应用
```bash
# 安装iOS依赖（需要手动处理CocoaPods）
cd ios
pod install  # 如果CocoaPods可用

# 构建应用
cd ..
npx react-native run-ios
```

## 🎯 测试步骤

### 基础功能测试
1. **启动两个模拟器**
   - iPhone 14 Pro
   - iPhone 14 Plus

2. **登录用户**
   - 每个模拟器使用不同的用户
   - 确保用户信息正确显示

3. **创建对话**
   - 在一个模拟器扔瓶子
   - 在另一个模拟器捡瓶子
   - 回复消息建立对话

### 通话功能测试

#### 语音通话测试
1. **进入消息列表**
   - 点击"消息"标签
   - 选择已有的对话

2. **发起语音通话**
   - 点击聊天界面右上角的电话图标 📞
   - 观察通话界面是否正常显示

3. **通话控制**
   - 测试静音/取消静音
   - 测试扬声器切换
   - 测试挂断功能

#### 视频通话测试
1. **发起视频通话**
   - 点击聊天界面右上角的摄像头图标 📹
   - 观察视频界面是否正常显示

2. **视频控制**
   - 测试摄像头开关
   - 测试前后摄像头切换
   - 测试静音功能
   - 测试挂断功能

## 🔧 技术架构

### 前端组件
- **WebRTCCallManager**: WebRTC连接管理
- **CallScreen**: 通话界面组件
- **MessagesScreen**: 集成通话按钮

### 后端服务
- **API服务器** (端口3000): 用户、瓶子、消息管理
- **信令服务器** (端口3001): WebRTC信令交换

### 依赖库
- `react-native-webrtc`: WebRTC核心功能
- `react-native-permissions`: 权限管理
- `react-native-incall-manager`: 通话管理
- `socket.io-client`: 实时通信

## 📱 界面说明

### 聊天界面
- **电话图标** 📞: 发起语音通话
- **摄像头图标** 📹: 发起视频通话

### 通话界面
- **接听/拒绝按钮**: 来电时显示
- **静音按钮**: 切换麦克风状态
- **扬声器按钮**: 切换音频输出
- **摄像头按钮**: 切换摄像头状态（仅视频通话）
- **切换摄像头按钮**: 前后摄像头切换（仅视频通话）
- **挂断按钮**: 结束通话

## 🐛 常见问题

### 1. 权限问题
**问题**: 无法访问麦克风或摄像头
**解决**: 
- 检查Info.plist权限配置
- 在设置中手动授权
- 重启应用

### 2. 连接问题
**问题**: 无法建立通话连接
**解决**:
- 检查信令服务器是否运行
- 确认网络连接正常
- 查看控制台错误信息

### 3. 音视频质量问题
**问题**: 音视频质量差或延迟高
**解决**:
- 检查网络带宽
- 调整WebRTC配置
- 优化设备性能

## 📊 测试检查清单

### 基础功能
- [ ] 应用正常启动
- [ ] 用户登录成功
- [ ] 消息列表正常显示
- [ ] 聊天界面正常打开

### 语音通话
- [ ] 语音通话按钮可点击
- [ ] 通话界面正常显示
- [ ] 音频流正常传输
- [ ] 静音功能正常
- [ ] 扬声器切换正常
- [ ] 挂断功能正常

### 视频通话
- [ ] 视频通话按钮可点击
- [ ] 视频界面正常显示
- [ ] 本地视频正常显示
- [ ] 远程视频正常显示
- [ ] 摄像头切换正常
- [ ] 视频开关正常

### 网络功能
- [ ] 信令服务器连接正常
- [ ] WebRTC连接建立成功
- [ ] 音视频数据正常传输
- [ ] 通话状态同步正常

## 🎉 成功标准

### 功能完整性
- ✅ 语音通话功能完整
- ✅ 视频通话功能完整
- ✅ 通话控制功能完整
- ✅ 界面交互流畅

### 性能指标
- ✅ 通话建立时间 < 3秒
- ✅ 音视频延迟 < 200ms
- ✅ 通话质量稳定
- ✅ 内存使用合理

### 用户体验
- ✅ 界面美观易用
- ✅ 操作响应及时
- ✅ 错误处理友好
- ✅ 功能逻辑清晰

## 📈 下一步优化

### 功能增强
- [ ] 群组通话支持
- [ ] 通话录制功能
- [ ] 屏幕共享功能
- [ ] AI降噪功能

### 性能优化
- [ ] 自适应码率
- [ ] 网络质量检测
- [ ] 断线重连机制
- [ ] 电池优化

### 用户体验
- [ ] 通话通知
- [ ] 通话历史
- [ ] 通话质量显示
- [ ] 多语言支持

---

## 🎯 测试完成确认

当所有测试项目都通过后，语音/视频通话功能就成功实现了！

**测试负责人**: ___________  
**测试日期**: ___________  
**测试结果**: ✅ 通过 / ❌ 失败  
**备注**: ___________
