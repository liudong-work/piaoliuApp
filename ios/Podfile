require_relative '../node_modules/react-native/scripts/react_native_pods'
require_relative '../node_modules/@react-native-community/cli-platform-ios/native_modules'

platform :ios, '15.0'

target 'piaoliuapp' do
  config = use_native_modules!

  # ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬çš„ RCT-Folly é¿å…ç¼–è¯‘é”™è¯¯
  pod 'RCT-Folly', :podspec => '../node_modules/react-native/third-party-podspecs/RCT-Folly.podspec'
  
  # æ·»åŠ  react-native-vector-icons
  pod 'RNVectorIcons', :path => '../node_modules/react-native-vector-icons'
  
  # WebRTC ç›¸å…³ä¾èµ– (ä½¿ç”¨å®˜æ–¹ç‰ˆæœ¬)
  pod 'RNPermissions', :path => '../node_modules/react-native-permissions'
  pod 'ReactNativeIncallManager', :path => '../node_modules/react-native-incall-manager'
  pod 'react-native-webrtc', :path => '../node_modules/react-native-webrtc'

  # React Native æ ¸å¿ƒåº“
  use_react_native!(
    :path => config[:reactNativePath],
    :hermes_enabled => false,        # ç¦ç”¨ Hermes é¿å… RCT-Folly é—®é¢˜
    :fabric_enabled => false,        # å¯æ”¹ true å¼€å¯æ–°æ¶æ„ Fabric
    :flipper_configuration => FlipperConfiguration.disabled,
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )
  
  # å®Œå…¨ç¦ç”¨ RCT-Folly ä»¥é¿å…ç¼–è¯‘é—®é¢˜
  pod 'RCT-Folly', :podspec => '../node_modules/react-native/third-party-podspecs/RCT-Folly.podspec', :inhibit_warnings => true

  target 'piaoliuappTests' do
    inherit! :complete
  end

  post_install do |installer|
    react_native_post_install(
      installer,
      :mac_catalyst_enabled => false
    )

    # ğŸ‘‡ æ¨èåŠ ä¸Šè¿™ä¸€æ®µï¼Œè§£å†³ iOS æ„å»ºæ—¶å¤´æ–‡ä»¶æ‰¾ä¸åˆ°çš„é—®é¢˜
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++17'
      config.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
      
  # RCT-Folly è­¦å‘Šå·²é€šè¿‡ :inhibit_warnings => true ç¦ç”¨
  
  # æ–¹æ³•2: ç»™ RCT-Folly æ·»åŠ ç¼–è¯‘å‚æ•°å¿½ç•¥ typedef å†²çª
  if target.name == 'RCT-Folly'
    config.build_settings['OTHER_CFLAGS'] ||= ['$(inherited)']
    config.build_settings['OTHER_CFLAGS'] << '-Wno-typedef-redefinition'
    config.build_settings['OTHER_CFLAGS'] << '-Wno-error=typedef-redefinition'
    config.build_settings['GCC_WARN_TYPEDEF_REDEFINITION'] = 'NO'
    config.build_settings['GCC_WARN_MACRO_REDEFINITION'] = 'NO'
    config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'
  end
      
      # è§£å†³ WebRTC ç¼–è¯‘é”™è¯¯
      if target.name == 'react-native-webrtc'
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] ||= []
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << 'WEBRTC_IOS=1'
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << 'WEBRTC_MAC=1'
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << 'WEBRTC_POSIX=1'
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << 'WEBRTC_ARCH_ARM64=1'
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << 'WEBRTC_ARCH_X86_64=1'
        # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ iOS SDK
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
        # æ·»åŠ å¿…è¦çš„æ¡†æ¶
        config.build_settings['OTHER_LDFLAGS'] ||= []
        config.build_settings['OTHER_LDFLAGS'] << '-framework AVFoundation'
        config.build_settings['OTHER_LDFLAGS'] << '-framework CoreMedia'
        config.build_settings['OTHER_LDFLAGS'] << '-framework CoreVideo'
      end
      
      # è§£å†³ FLT_MAX å’Œ FLT_MIN æœªå£°æ˜é”™è¯¯
      if target.name.include?('boost') || target.name.include?('RCT-Folly')
        config.build_settings['OTHER_CFLAGS'] ||= ['$(inherited)']
        config.build_settings['OTHER_CFLAGS'] << '-include'
        config.build_settings['OTHER_CFLAGS'] << 'float.h'
        config.build_settings['OTHER_CFLAGS'] << '-include'
        config.build_settings['OTHER_CFLAGS'] << 'math.h'
        config.build_settings['OTHER_CFLAGS'] << '-include'
        config.build_settings['OTHER_CFLAGS'] << 'limits.h'
      end
    end
  end

  # è§£å†³ RCT-Folly çš„ clockid_t é‡å®šä¹‰é—®é¢˜
  # é€šè¿‡åœ¨ post_install é˜¶æ®µä¿®æ”¹ Time.h æ–‡ä»¶
  file_path = "#{installer.pods_project.path}/../Pods/RCT-Folly/folly/portability/Time.h"
  if File.exist?(file_path)
    content = File.read(file_path)
    # æŸ¥æ‰¾å¹¶æ›¿æ¢ typedef uint8_t clockid_t;
    # ç¡®ä¿åªæ›¿æ¢æœªè¢«å®åŒ…è£¹çš„å®šä¹‰
    if content.include?("typedef uint8_t clockid_t;") && !content.include?("#ifndef __APPLE__\ntypedef uint8_t clockid_t;\n#endif")
      new_content = content.gsub("typedef uint8_t clockid_t;", "#ifndef __APPLE__\ntypedef uint8_t clockid_t;\n#endif")
      File.open(file_path, "w") { |file| file.puts new_content }
      puts "âœ… Successfully patched RCT-Folly/folly/portability/Time.h for clockid_t redefinition."
    end
  end
  end
end
